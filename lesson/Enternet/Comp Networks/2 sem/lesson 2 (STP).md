# Spanning-Tree Protocol

## Необходимость использования STP и принцип его работы

![img.png](img/lesson3/debug_EtherChannel.png)

Эталон построения локальные комп сетей является трехуровневая иерархическая модель построения сети
которая подразумевает наличие избыточности оборудования и каналов связи это позволяет нам создавать резервные пути для
трафика, чтобы сети были всегда доступны.

Но наличие избыточности ведет к проблемам в такой локальной сети, которые могут привести сеть к неправильной работе или
вообще к отказу обслуживанию. Такими проблемами могут быть:

1. Нестабильность базы данных MAC-адресов(копии одного кадра принимаются на разных портах)
2. Широковещательные штормы(широковещательные рассылки распространяются непрерывно, что вызывает нарушение в сети)
3. Множественная передача кадров(*несколько копий одноадресных кадров направляются в один пункт назначения)

### Неустойчивость таблицы MAC-адресов

![alt text](img/lesson2/lesson2_sem2_Macadrtable.png)

### Широковещательный шторм

![broadcast_storm.jpg](img/lesson2/broadcast_storm.jpg)

### Дублирование кадров

![Duplication_frames.jpg](img/lesson2/Duplication_frames.jpg)

### STP

![STP.png](img/lesson2/STP.png)

![alg_STP.png](img/lesson2/alg_STP.png)

![alg_STP2.png](img/lesson2/alg_STP2.png)

## Алгоритм работы STP

## Формат BPDU

Все процессы STP происходят благодаря обмену коммутаторами информации BPDU

![alt text](img/lesson2/lesson2_stp_formatBPDU.png)

1-4 -

Главные поля 5-8

- Root ID  (Информация корневого порта)
- Root Path Cost (стоимость пути до корневого порта)
- Bridge ID (Идентификатор конкретного коммутатора)
- Port ID (Идентификатор порта с которого получено сообщение)

9-12 поля описывающие данные которые используются при работе алгоритма STP

в WireShark
![alt text](img/lesson2/lesson2_WireSharkBPDU.png)

**!Важно понимать что все эти таймеры задаются на корневом коммутаторе**

### Что такое Bridge id

![](img/lesson2/lesson2_BridgeID.png)

Bridge ID имеет 3 поля:

1. Приоритет моста - 4 бит значение по умолчанию - 32768
2. Расширенный Идентификатор сети - необязательное, т.к в ранних версиях было только 2 поля (12 бит равняется номеру
   VLAN к которому строится дерево)
3. MAC-address - мак адрес коммутатора

### Алгоритм STP: Root Bridge

![alg_Root_Bridge.png](img/lesson2/alg_Root_Bridge.png)

Приоритеты меняются вручную значения от 0 до 61440 с шагом 4096

Главный мост - наименьший приоритет среди всех. Если значение приоритета не менялось, то будет выбор по мак адресу

![alg_Root_Bridge_MAC.png](img/lesson2/alg_Root_Bridge_MAC.png)

Лучше всегда вручную ставить приоритет, чтобы выбрать главный коммутатор.

**Подробный алгоритм:**

![alg_Root_Bridge2.png](img/lesson2/alg_Root_Bridge2.png)

На первом этапе каждый коммутатор объявляет себя рутом и далее BPDU рассылаются всем коммутаторам в сети(левый рисунок).

Коммутаторы получив значения от других коммутаторов сравнивают пришедшие ROOT_Id со своими BRIDGE_Id.

Если собственный bridgeid меньше чем rootid, то в новом рассылаемом BPDU указывается собственный bridgeid в качестве
rootid и начинает такое сообщение BPDU рассылаться дальше по сети.

Если ситуация обратная (bridgeid > rootid), то мы оставляем rootid который получили и оставляем свой bridgeid.

### Агоритм STP: Стоимость корневого пути

![alg_STP_Cost_Root_Id.png](img/lesson2/alg_STP_Cost_Root_Id.png)

После выбора Root Bridge, все процессы регулируются именно этим коммутатором. Т.е все что дальше происходит в алгоритме
STP, происходит за счет тех сообщений, которые были отправлены корневым коммутатором.

![alg_Root_Cost.png](img/lesson2/alg_Root_Cost.png)

### Роли портов STP

![STP_Role_Ports.png](img/lesson2/STP_Role_Ports.png)

Всего 3 вида роли портов:

1. Designated Port - назначенный порт, **Активный порт**. Также является портом с минимальной стоимостью пути.
2. Root Port - порты коммутаторов, которые не являются корневым коммутатором, а также Root port выбираются для
   коммутаторов с минимальной стоимость до корневого пути. **Всегда должен быть в активном состоянии, т.к он включен в
   процесс построения дерева**
3. Alternate Port - резервный порт, для назначения порта, если другая сторона не является корневым портом

![img.png](img/lesson2/STP_Role_Ports2.png)

У нас в сети есть еще сегмент, где 2 активных порта S2 S3 и если мы их оставим активными, то мы оставим циклирование
трафика и другие различные проблемы.

Нам надо выбрать какой порт будет заблокированным, а какой активным.

Alternate Port будет выбираться там где большее значение Bridge_ID. Он не полностью блокирует порт, если дерево будет
перестроено, то этот порт станет активным, т.к был настроен.
![STP_Role_Ports3.png](img/lesson2/STP_Role_Ports3.png)

### Выбор Designated и Alternate портов

![Choose_Alternate_Designate_Port.png](img/lesson2/Choose_Alternate_Designate_Port.png)

### Состояние порта

Прежде чем будет происходить отправка данных через каждый порт коммутатора этот порт должен пройти через несколько
состояний:

* Канал поднимается
* Переходит в **Блокирующий режим** - через этот режим у нас не отправляются и не получаются данные
* Переходит сразу в **Режим Прослушивания** - чтобы изучить как построено и построить дерево STP и понять роль этого
  порта. Получает BPDU, чтобы определить путь корня и передает собственный BPDU соседним коммутаторам, чтобы они тоже
  участвовали в построении топологии
* переход в состояние **Обучения** - здесь порт получает обрабатываемый BPDU и готовится к пересылке кадров, если он
  переведен в активный режим. Но при этом обычный трафик клиентов все еще не передается
* **Режим пересылки** - передает трафик клиентов, является активным состоянием порта

![port_status.png](img/lesson2/port_status.png)

## Виды STP

### Типы STP

![Type_STP.png](img/lesson2/Type_STP.png)

* STP - имеет упрощенный вид Bridge ID(состоит из двух полей) т.к не предполагало множество vlan
* PVST+ (cisco) - улучшенный STP, который подразумевает для каждого VLAN отдельное дерево STP
* RSTP - является таким же STP, только быстрее в работе
* RAPID PVST+ (cisco) - делает тоже самое что и RSTP, который подразумевает для каждого VLAN отдельное дерево STP
* Современные MSTP и MST (cisco) - строят деревья для каждой отдельной VLAN, но сохраняет отдельный экземпляр для
  повторяющихся
  деревьев, что сохраняет ресурсы.

### Характеристики STP

![Characteristics_STP.jpg](img/lesson2/Characteristics_STP.jpg)

### Состояния и роли портов в RSTP(Rapid PVST+)

![Role_Mode_Ports_RSTP.png](img/lesson2/Role_Mode_Ports_RSTP.png)

**Backup port** - может быть назначен если у нас разделяемая среда и к ней есть доступ к резервным каналам связи.

### PortFast и BPDU Guard

![Portfast_BPDUGuard.png](img/lesson2/Portfast_BPDUGuard.png)

PortFast - пограничный порт который подключен к клиентам

## Настройка и отладка STP

### Настройка BID

![setting_BID.png](img/lesson2/setting_BID.png)

### Настройка стоимости порта

![setting_cost_port.png](img/lesson2/setting_cost_port.png)

### Настройка PortFast и BPDU Guard

![setting_PortFast_BPDGuard.png](img/lesson2/setting_PortFast_BPDGuard.png)

### Настройка Rapid PVST+

![setting_Rapid_PVST+.png](img/lesson2/setting_Rapid_PVST%2B.png)

### Отладка STP

![debug_STP.png](img/lesson2/debug_STP.png)

**show spanning-tree**

![show_spanning_tree.png](img/lesson2/show_spanning_tree.png)

**show spanning-tree active**

![show_spanning_tree_active.png](img/lesson2/show_spanning_tree_active.png)

**show spanning-tree vlan**

![show_spanning_tree_vlan.png](img/lesson2/show_spanning_tree_vlan.png)

### Диаметр STP - 7 коммутаторов

